FROM r-base:4.5.2

LABEL org.opencontainers.image.licenses="GPL-3.0-or-later"

ARG NCPUS=-1

# System deps (pak + compilation + git; curl also used for rust/torch downloads)
RUN apt-get update -qq && apt-get install -y --no-install-recommends \
    curl ca-certificates git \
    libcurl4-openssl-dev \
    libssl-dev libxml2-dev \
    build-essential g++ cmake \
  && rm -rf /var/lib/apt/lists/*

# Rust (safe to include; helps if any dependency needs it)
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Install pak + add mlr3 repos, then install the packages you actually load (+ deps)
RUN Rscript -e "install.packages('pak', repos='https://cloud.r-project.org'); \
  Sys.setenv(NOT_CRAN='true'); \
  pak::repo_add(mlr3universe='https://mlr-org.r-universe.dev', multiverse='https://community.r-multiverse.org'); \
  pak::pak(c( \
    'mlr3verse', \
    'bbotk', \
    'mlr3learners', \
    'mlr3extralearners', \
    'mlr3hyperband', \
    'mlr3batchmark', 'batchtools', \
    'torch', \
    'remotes', \
    'BART', \
    'gausscov', \
    'PlantedML/randomPlantedForest', \
    'mlr-org/mlr3torch', \
    'MislavSag/mlr3finance' \
  ), dependencies=TRUE, ask=FALSE)"

# Torch runtime (downloads libtorch into the image)
RUN Rscript -e "torch::install_torch()"

# Optional but convenient
ENV NOT_CRAN=true