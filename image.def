Bootstrap: docker
From: r-base:4.5.2

%labels
  org.opencontainers.image.licenses GPL-3.0-or-later

%post
  set -e

  # ---- System deps (pak + compilation + git; curl also used for rust/torch downloads) ----
  apt-get update -qq
  apt-get install -y --no-install-recommends \
    curl ca-certificates git \
    libcurl4-openssl-dev \
    libssl-dev libxml2-dev \
    build-essential g++ cmake
  rm -rf /var/lib/apt/lists/*

  # ---- Rust (helps if any dependency needs it) ----
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  . /root/.cargo/env

  # ---- R packages via pak (mlr3-style) ----
  R --slave -e "install.packages('pak', repos='https://cloud.r-project.org')"
  R --slave -e "Sys.setenv(NOT_CRAN='true'); \
                pak::repo_add(mlr3universe='https://mlr-org.r-universe.dev', \
                              multiverse='https://community.r-multiverse.org'); \
                pak::pak(c( \
                  'mlr3verse', \
                  'bbotk', \
                  'mlr3learners', \
                  'mlr3extralearners', \
                  'mlr3hyperband', \
                  'mlr3batchmark', 'batchtools', \
                  'torch', \
                  'remotes', \
                  'BART', \
                  'gausscov', \
                  'PlantedML/randomPlantedForest', \
                  'mlr-org/mlr3torch', \
                  'MislavSag/mlr3finance' \
                ), dependencies=TRUE, ask=FALSE)"

  # ---- Torch runtime (downloads libtorch into the image) ----
  R --slave -e "torch::install_torch()"

%environment
  # make Rust available at runtime too
  export PATH="/root/.cargo/bin:${PATH}"
  export NOT_CRAN="true"

%runscript
  exec Rscript "$@"
